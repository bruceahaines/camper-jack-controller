<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Camper Jack Controller</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="bootstrap/bootstrap.min.css" media="screen">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script>
    window.jQuery || document.write('<script src="jquery/jquery-3.4.1.min.js">\x3C/script>')
  </script>
  <script src="bootstrap/bootstrap.min.js"></script>
  <script>
    //**************************************************************************
    // setup Websockets
    //**************************************************************************
    // use below when hosted on ESP8266
    //var wsUri = 'ws://' + location.hostname + ':81/';
    // use below for connecting to ESP server via IP address (when testing code on PC)
    // var wsUri = 'ws://192.168.1.120:81/';
    // use below for connecting to Nodejs server (when testing code on PC)
    var wsUri = 'ws://localhost:80/';
    var output;
    var echo = "";
    var gbl_requestMsg = []; // array of messages to be sent out the websocket.
    //**************************************************************************
    // Init - called when Event Listener loads
    //**************************************************************************
    function init() {
      console.log("Initiating Home page");
      //openWebsocket();
      //formatRequest("queryGPIO", "2");
    }
    //**************************************************************************
    // open Websockets - as the name suggests
    //**************************************************************************

    gbl_websocket = new WebSocket(wsUri);

    gbl_websocket.onopen = function () {
        console.log("Websocket opened.");
        // If we had messages pushed before websocket was ready, pop them now.
        while (gbl_requestMsg.length > 0) {
          message = gbl_requestMsg.pop();
          console.log("Popping message ", message, " from queue.");
          gbl_websocket.send(message);
          console.log("Message queue now empty.");          
        }
      }

      gbl_websocket.onclose = function (evt) {
        console.log("Websocket disconnected");
      };

      gbl_websocket.onmessage = function (evt) {
        console.log("Websocket message recieved.")
        onMessage(evt);
      };

      gbl_websocket.onerror = function (evt) {
        console.log("Websocket Error! " + evt.data);
        document.getElementById("pageStatus").style.color = "red";
        document.getElementById("pageStatus").innerHTML = "Failed to Connect.  Reload to Retry.";
      };


    //**************************************************************************
    // Query Websockets
    // Take action as required on webSocket
    // Either queues or sends messages based on readyState of the socket
    //**************************************************************************
/*     function queryWebSocket(request) {
      if (websocket.readyState == 3) {
        console.log("Websocket not open, opening.")
        openWebsocket();
      }
      console.log("Requesting: ", request);
      if (websocket.readyState !== 1) {
        gbl_requestMsg.push(request);
        console.log("request pushed to array");
      } else {

        websocket.send(request);
        // check if websocket is open here
        console.log("request sent to websocket");
      }

    } */
    //**************************************************************************
    // Runs when websocket is recieved or is sent(?)
    //**************************************************************************
    function onMessage(evt) {
      var messageRecieved = evt.data;
      var jsonMessage = JSON.parse(messageRecieved);
      console.log("Message Recieved is: " + messageRecieved);
      document.getElementById("pageStatus").style.visibility = "hidden";
      
      console.log("Set pin " + 
                  jsonMessage.pinNum + 
                  " to " + 
                  jsonMessage.pinReadState);

      document.getElementById("status").innerHTML = "Pin " +
            jsonMessage.pinNum +
            " is " +
            jsonMessage.pinReadState + 
            ".";
      
      //document.getElementById("b1").focus();
      //console.log("Setting Focus B1");
    }
    // This listener is required to action websocket requests.
    window.addEventListener("load", init, false);
  </script>
  <script>
    $(document).ready(function () {
      console.log('Document ready.');
    });
    //**************************************************************************
    // setIO
    // Sets required state of chosen IO by using a websocket msg
    //**************************************************************************
    function setIO(io, state) {

      // serialize the request into JSON
      var jsonRequest = JSON.stringify({
        "pinNum": io,
        "pinState": state
      }); 

      console.log("Serialized websocket msg:");
      console.log(jsonRequest);

      // Use websockets to send message to MCU.
      if (gbl_websocket.readyState !== 1) {
        gbl_requestMsg.push(jsonRequest);
        console.log("Websocket not ready, msg pushed to array.");
      } 
      else { // websocket.readyState == 1
        gbl_websocket.send(jsonRequest);
        // check if websocket is open here
        console.log("Websocket msg sent.");
      }

      // Prevously done with an AJAX request to open a file.
      // On MCU we handled it as fileNotFound and then compare strings.
      // Uncomment this to change IO via AJAX
      /*console.log("IO ", io, " requested with state: ", state, ".");
      request = new XMLHttpRequest();
      requestData = "GPIO_" + io + "_" + state;
      request.open("GET", requestData, true);
      request.send(); //Used to say NULL in parentheses...
      console.log("AJAX request sent");*/
      //document.getElementById("status").innerHTML = "GPIO is: " + state;

    }

  </script>
  <style>
    #footer {
      position: absolute;
      bottom: 0;
    }
  </style>
</head>

<body>
  <div class="container" style="text-align:center;">
    <h1> Camper Jack Controller </h1>
        <p id="pageStatus">No Current Status</p>
    <!-- Buttons ================================================== -->
    <div class="container">
      <br />

        <!--// Left side of Wemos D1 Mini Pro as seen aligned with top writing.
            #define LF_UP_PIN D0 // GPIO16 //Left Front Up. Up corresponds to +12V on the RED wire.
            #define LF_DOWN_PIN D5 // GPIO14 
            #define RF_UP_PIN D6 // GPIO12 
            #define RF_DOWN_PIN D7 // GPIO13 
            // Right side of Wemos D1 Mini Pro as seen aligned with top writing.
            #define LR_UP_PIN D1 // GPIO5 
            #define LR_DOWN_PIN D2 // GPIO4
            #define RR_UP_PIN D3 // GPIO0
            #define RR_DOWN_PIN D4 // GPIO2 -->
      <table class="table">
        <tr>
          <th>Left Front</th>
          <th>Right Front</th>
        </tr>
        <tr>
          <!-- LF_UP -->
          <td><button class="btn btn-primary btn-lg btn-block" onclick="setIO(16, 'ON');">UP</button></td>
          <!-- RF_UP -->
          <td><button class="btn btn-primary btn-lg btn-block" onclick="setIO(12, 'ON');">UP</button></td>
        </tr>
        <tr>
          <!-- LF_DOWN -->
          <td><button class="btn btn-primary btn-lg btn-block" onclick="setIO(14, 'ON');">DOWN</button></td>
          <!-- RF_DOWN -->
          <td><button class="btn btn-primary btn-lg btn-block" onclick="setIO(13, 'ON');">DOWN</button></td>
        </tr>
      </table>

      <table class="table">
        <tr>
          <th>Left Rear</th>
          <th>Right Rear</th>
        </tr>
        <tr>
          <!-- LR_UP -->
          <td><button class="btn btn-primary btn-lg btn-block" onclick="setIO(5, 'ON');">UP</button></td>
          <!-- RR_UP -->
          <td><button class="btn btn-primary btn-lg btn-block" onclick="setIO(0, 'ON');">UP</button></td>
        </tr>
        <tr>
          <!-- LR_DOWN -->
          <td><button class="btn btn-primary btn-lg btn-block" onclick="setIO(4, 'ON');">DOWN</button></td>
          <!-- RR_DOWN -->
          <td><button class="btn btn-primary btn-lg btn-block" onclick="setIO(2, 'ON');">DOWN</button></td>
        </tr>
      </table>

      <button class="btn btn-danger btn-lg btn-block" onclick="setIO(99, 'ON')">STOP</button>


            <h3 id="status">GPIO is Undefined</h3>
    </div>
  </div>
  <div class="container" style="text-align:right;" id="footer">
    <p>bruce.a.haines@gmail.com</p>
  </div>
</body>

</html>